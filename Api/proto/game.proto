syntax = "proto3";

option java_package = "com.grpc";
option java_multiple_files = true;

package game;

// === СЕРВИСЫ ===

// AuthService: Работает на главном Kotlin-сервере.
// Точка входа для всех игроков.
service AuthService {
  // Шаг 1: Обмен кода Google на игровой JWT
  rpc AuthenticateWithGoogle (GoogleAuthRequest) returns (AuthResponse);

  // Шаг 2 (Опционально): Обновление токена, если он протух
  rpc RefreshToken (RefreshRequest) returns (AuthResponse);
}

// GameService: Работает на главном Kotlin-сервере (Lobby/Master Server).
// Отвечает за поиск комнат и оркестрацию Docker-контейнеров.
service LobbyService {
  // Запрос на поиск или создание комнаты (здесь триггерится спавн Docker)
  rpc JoinRoom (JoinRoomRequest) returns (JoinRoomResponse);
}

// DedicatedService: Будет работать внутри созданного C++ контейнера.
// Сюда клиент подключается после того, как получил адрес из JoinRoom.
service DedicatedService {
  rpc Ping (PingRequest) returns (PingResponse);
}

// === СООБЩЕНИЯ ===

// --- Авторизация ---

message GoogleAuthRequest {
  string auth_code = 1;     // Код, полученный Unreal от браузера
  string redirect_uri = 2;  // Должен совпадать с тем, что был в Unreal (http://localhost:1234)
}

message RefreshRequest {
  string refresh_token = 1;
}

message AuthResponse {
  string access_token = 1;  // Игровой JWT (подписанный твоим сервером)
  string player_id = 2;     // Уникальный ID игрока в твоей базе
  int64 expires_at = 3;     // Timestamp истечения токена
}

// --- Лобби и Оркестрация ---

message JoinRoomRequest {
  string room_name = 1;     // Имя комнаты или тип матча (например, "ranked")
}

message JoinRoomResponse {
  ResponseStatus status = 1;
  string message = 2;

  // Данные для подключения к C++ серверу
  ServerInfo server_info = 3;
  string room_session_id = 4;
}

message ServerInfo {
  string address = 1;       // IP:Port (например, "1.2.3.4:55001")
  string server_version = 2;
}

enum ResponseStatus {
  OK = 0;
  ALREADY_IN_ROOM = 1;
  ROOM_FULL = 2;
  SERVER_STARTING = 3;      // Полезно для UI: "Подождите, сервер разворачивается"
  ERROR = 4;
}

// --- Тестовые сообщения для C++ сервера ---

message PingRequest {
  int64 client_time = 1;
}

message PingResponse {
  int64 server_time = 1;
}